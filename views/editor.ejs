<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post Editor</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" crossorigin="anonymous">
    <!-- Include Tailwind CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.2/dist/tailwind.min.css" rel="stylesheet">
    <!-- Include stylesheet for Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
    <div class="flex flex-wrap w-full">
        <header class="w-full text-center py-4 bg-white shadow">
            <h1 class="text-3xl font-bold">Admin Panel</h1>
        </header>
        <!-- Posts Column -->
        <div class="w-1/4 bg-white p-4 shadow" style="max-height: 90vh; overflow-y: auto;">
            <ul>
                <% posts.forEach(post => { %>
                    <li class="post-item mb-4 p-2 relative hover:bg-blue-100 cursor-pointer" onclick="selectPostForEdit(this, <%= post.id %>)">
                        <!-- Clicking on this div will load the post -->
                        <div>
                            <h2 class="text-xl font-bold"><%= post.title %></h2>
                            <p><%= post.preview %></p>
                            <p class="text-sm text-gray-500">Published: <%= new Date(post.date_created).toLocaleDateString() %></p>
                        </div>
                        <!-- Delete button positioned absolutely to the top right corner -->
                        <button onclick="deletePost(<%= post.id %>)" class="absolute top-0 right-0 mt-2 mr-2 bg-gray-200 hover:bg-red-500 text-white font-bold py-1 px-2">
                            <i class="fa fa-trash"></i>
                        </button>
                    </li>
                <% }) %>
            </ul>
        </div>
        <!-- Editor Column -->
        <div class="w-full md:w-1/2 p-4">
            <form id="postForm" action="/submit" method="POST" class="space-y-6">
                <div class="flex flex-col">
                    <label for="title" class="mb-2 font-semibold">Title:</label>
                    <input type="text" id="title" name="title" class="form-input px-4 py-2 focus:border-blue-500 focus:outline-none" required>
                </div>
                <!-- New preview input box -->
                <div class="flex flex-col">
                    <label for="preview" class="mb-2 font-semibold">Preview:</label>
                    <textarea id="preview" name="preview" rows="3" class="form-textarea px-4 py-2 focus:border-blue-500 focus:outline-none" placeholder="Enter a preview of your post" required></textarea>
                </div>
                <!-- Create the editor container -->
                <div id="editor-container" class="bg-white"></div>
                <input type="hidden" id="editorContent" name="text">
                <div class="flex flex-col">
                    <label for="image" class="mb-2 font-semibold">Image:</label>
                    <input type="file" id="image" name="image" accept="image/*" multiple class="form-input px-4 py-2 border focus:border-blue-500 focus:outline-none">
                </div>
                <div class="flex flex-col">
                    <label for="dateCreated" class="mb-2 font-semibold">Date:</label>
                    <input type="date" id="dateCreated" name="dateCreated" class="form-input px-4 py-2 border focus:border-blue-500 focus:outline-none" disabled>
                </div>
                <button type="button" id="submitPostButton" class="px-4 py-2 bg-blue-500 text-white hover:bg-blue-700 focus:outline-none">Submit Post</button>
            </form>
        </div>
    </div>
    <footer class="text-center py-5 mt-auto">
        <p>All rights reserved. &copy; Surya Polina</p>
    </footer>

    <script>
        // Initialize Quill editor
        var quill = new Quill('#editor-container', {
            theme: 'snow'
        });

        function submitPost() {
            // Get the HTML content of the editor
            var htmlContent = quill.root.innerHTML;

            // Set the hidden input's value to the HTML content
            document.getElementById('editorContent').value = htmlContent;

            // Now, you can submit the form. If you're using AJAX to submit the form, you can do it here.
            // For a standard form submission:
            document.getElementById('postForm').submit();
        }

        function loadPost(postId) {
            // Highlight the selected post
            const selectedPost = document.querySelector(`[data-post-id="${postId}"]`);
            if (selectedPost) {
                selectedPost.classList.add('bg-blue-100'); // Add the selection class to the clicked post
            }
            // Send AJAX request to get the post data
            fetch(`/post/${postId}`)
                .then(response => response.json())
                .then(data => {
                  // Populate the form fields
                  document.getElementById('title').value = data.title;
                  document.getElementById('preview').value = data.preview;
                  // Set the editor content
                  quill.clipboard.dangerouslyPasteHTML(data.text);
              // If you have a field for the image, you would need to handle that too
            })
            .catch(error => console.error('Error loading post:', error));
        }

        function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            fetch(`/post/${postId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        // Remove the post element from the DOM or refresh the page
                        alert('Post deleted successfully');
                        window.location.reload(); // This line will refresh the page
                    } else {
                        alert('Error deleting post');
                    }
                })
                .catch(error => {
                    console.error('Error deleting post:', error);
                });
        }

        // In your client-side code
        function updatePost() {
          // Get the post ID
          const postId = selectedPostId;

          // Prepare the post data from the form
          const title = document.getElementById('title').value;
          const preview = document.getElementById('preview').value;
          const text = quill.root.innerHTML; // Assuming you're using Quill editor
          
          // Construct the request payload
          const postData = { title, preview, text };

          // Send the PUT request to the server
          fetch(`/post/${postId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              // Include any other headers like authorization headers if needed
            },
            body: JSON.stringify(postData)
          })
          .then(response => response.json())
          .then(data => {
            console.log(data);
            // Handle success, maybe refresh the list of posts or provide user feedback
          })
          .catch(error => console.error('Error updating post:', error));
        }

        let selectedPostId = null;
        function selectPostForEdit(postElement, postId) {
          if (selectedPostId === postId) {
            // Deselect the post
            selectedPostId = null;
            postElement.classList.remove('bg-blue-100');
            document.getElementById('submitPostButton').textContent = 'Submit Post';
            resetForm(); // Make sure this function clears the form
          } else {
            // Clear previously selected post
            if (selectedPostId !== null) {
              document.querySelector('.post-item.bg-blue-100').classList.remove('bg-blue-100');
            }

            // Select the new post
            selectedPostId = postId;
            postElement.classList.add('bg-blue-100');
            document.getElementById('submitPostButton').textContent = 'Update Post';
            loadPost(postId); // Make sure this function populates the form with the selected post's data
          }
        }

        function resetForm() {
          // Reset the form fields
          document.getElementById('title').value = '';
          document.getElementById('preview').value = '';
          quill.setText('');
          document.getElementById('image').value = null;
          document.getElementById('dateCreated').value = '';
          
          // Reset the form action to submit
          document.getElementById('postForm').action = '/submit';
        }

        document.getElementById('submitPostButton').onclick = function() {
          if (selectedPostId) {
            updatePost();
          } else {
            submitPost();
          }
        };

    </script>
</body>
</html>
